---
title: "Placental Aging Analysis"
author:
  - name: Herdiantri Sufriyana
    affiliation:
    - &ibi Institute of Biomedical Informatics, College of Medicine, National 
      Yang Ming Chiao Tung University, Taipei, Taiwan. 
    email: herdi@nycu.edu.tw
  - name: Emily Chia-Yu Su
    affiliation:
    - *ibi
date: "2025-01-10"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: true
vignette: >
  %\VignetteIndexEntry{Machine Learning Nomogram Exemplar}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Programming environment

```{r Load necessary packages}
library(tidyverse)
library(rplec)
```

# Data preprocessing

```{r Load our example data}
data(beta_values_case)
data(beta_values_control)
data(ga)
data(phenotype)
```

```{r Normalize DNA methylation values per sample}
norm_beta_values_case <- bmiq_norm_450k(beta_values_case)
norm_beta_values_control <- bmiq_norm_450k(beta_values_control)
```

# Quality control

```{r Estimate DNA-methylation-based gestational age}
dnam_ga_case <- plec(norm_beta_values_case)
dnam_ga_control <- plec(norm_beta_values_control)

dnam_ga <- rbind(dnam_ga_case, dnam_ga_control)
dnam_ga <-
  dnam_ga |>
  slice(match(rownames(ga), rownames(dnam_ga))) |>
  rename(estimated_GA = output)
```

```{r Perform quality control}
plec_calib <- calibration_plot(dnam_ga, ga)
plec_rmse <- rmse(dnam_ga, ga)
plec_mae <- mae(dnam_ga)
plec_r <- r(dnam_ga, ga)
```

# Identifying placental aging

```{r Estimate placental aging for control}
control <- which(colnames(norm_beta_values) %in% names(phenotype)[phenotype == "control"])
norm_beta_values_control <- norm_beta_values[, control]
aging_control <- plec(norm_beta_values_control, type = "residual")
ga_control <- ga[control, ]
results_control <- data.frame(phenotype = "control", aging = aging_control, ga = ga_control)
```

```{r Estimate placental aging for case}
case <- which(colnames(norm_beta_values) %in% names(phenotype)[phenotype == "case"])
norm_beta_values_case <- norm_beta_values[, case]
aging_case <- plec(norm_beta_values_case, type = "residual")
ga_case <- ga[case, ]
results_case <- data.frame(phenotype = "case", aging = aging_case, ga = ga_case)
```

```{r Plot placental aging across gestational age}
aging_plot <- rbind(results_control, results_case) |>
  ggplot(aes(x = ga, y = aging, color =  phenotype)) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_line() +
  xlab("Gestational age (weeks' gestation)") +
  ylab("Aging (accelerated/deccelerated = +/-")
```

```{r session-info, echo=TRUE}
sessionInfo()
```






